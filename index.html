<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VeChat ‚Äî Minimal</title>

  <!-- Íµ¨Í∏Ä Ìè∞Ìä∏ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- highlight.js Ïä§ÌÉÄÏùº -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/styles/atom-one-dark.min.css">

  <style>
    :root{
      --bg: #0f1115;
      --panel: #111217;
      --muted: #9aa4b2;
      --accent: #ff6b6b;
      --accent-2: #ffb86b;
      --bubble-user: linear-gradient(135deg,#ffd6d6,#ff6b6b);
      --bubble-bot: #0f1720;
      --radius: 14px;
      --glass: rgba(255,255,255,0.03);
      --max-width: 900px;
    }
    body.light {
      --bg: #f6f8fb;
      --panel: #ffffff;
      --muted: #6b7280;
      --accent: #ff3b30;
      --accent-2: #ff8a3d;
      --bubble-user: linear-gradient(135deg,#ffecec,#ffefef);
      --bubble-bot: #f3f4f6;
      --glass: rgba(0,0,0,0.03);
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color: #e6eef6; }
    body.light { color: #0b1220; }
    .app {
      max-width: var(--max-width);
      margin: 28px auto;
      border-radius: 16px;
      overflow: hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      box-shadow: 0 10px 40px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 70vh;
    }

    header.app-header {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:14px 18px;
      background: linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
      border-bottom: 1px solid rgba(255,255,255,0.02);
    }
    .title { display:flex; gap:12px; align-items:center; }
    .logo { width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2)); display:flex;align-items:center;justify-content:center;font-weight:700;color:#111;padding-top:2px; box-shadow: 0 6px 18px rgba(255,107,107,0.18); }
    .title h1 { font-size:16px;margin:0; }
    .title p { margin:0;font-size:12px;color:var(--muted); }

    .header-actions { display:flex; gap:8px; align-items:center; }
    .btn { border: none; background: var(--glass); color: inherit; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px; transition: transform .06s ease, background .12s ease; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(90deg,var(--accent),var(--accent-2)); color: #111; box-shadow: 0 8px 22px rgba(255,107,107,0.14); }
    .icon { opacity:0.9; margin-right:6px; }

    .chat-wrap { padding:18px; display:flex; flex-direction:column; gap:16px; height: calc(70vh - 120px); overflow:auto; background: transparent; }
    .msg { max-width: 86%; padding:14px 18px; border-radius: 14px; line-height:1.45; font-size:15px; white-space:pre-wrap; word-break:break-word; box-shadow: 0 6px 18px rgba(2,6,23,0.6); position:relative; }
    .msg.bot { background: var(--bubble-bot); align-self:flex-start; color: inherit; border-top-left-radius:6px; }
    .msg.user { background: var(--bubble-user); color: #111; align-self:flex-end; border-top-right-radius:6px; }
    .meta { font-size:12px; color:var(--muted); margin-bottom:8px; display:flex; gap:8px; align-items:center; }
    .meta .who { font-weight:700; }

    pre { margin:8px 0 0 0; padding:12px; border-radius:10px; overflow:auto; background: rgba(0,0,0,0.45); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "JetBrains Mono", monospace; font-size:13px; }
    body.light pre { background: rgba(0,0,0,0.06); }

    .copy-btn { position:absolute; right:10px; top:10px; background:var(--accent); color:#111; border:none; padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; cursor:pointer; z-index:2; }
    .pre-wrap { position:relative; margin-top:6px; }

    .composer { display:flex; gap:8px; align-items:flex-end; padding:14px; border-top:1px solid rgba(255,255,255,0.02); background: linear-gradient(180deg, transparent, rgba(0,0,0,0.02)); }
    textarea#input { flex:1; min-height:44px; max-height:160px; resize:none; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); background: transparent; color:inherit; font-size:15px; outline: none; box-shadow: inset 0 3px 10px rgba(0,0,0,0.3); }
    .small { font-size:13px; padding:8px 10px; border-radius:10px; }

    .muted { color:var(--muted); font-size:13px; }
    .center { text-align:center; }
    .spacer { flex:1; }

    @media (max-width:640px){
      .app { margin:12px; min-height:68vh; }
      .chat-wrap { height: calc(65vh - 110px); padding:12px; gap:12px; }
      .title h1 { font-size:14px; }
      .logo { width:36px;height:36px;font-size:14px; }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="VeChat minimal chat">
    <header class="app-header">
      <div class="title">
        <div class="logo" aria-hidden="true">VC</div>
        <div>
          <h1>VeChat</h1>
          <p class="muted">ÎØ∏ÎãàÎ©Ä Ï±ÑÌåÖ ¬∑ ÎßàÌÅ¨Îã§Ïö¥ + ÏΩîÎìú ÌïòÏù¥ÎùºÏù¥Ìä∏ ¬∑ Î°úÏª¨ Ï†ÄÏû•</p>
        </div>
      </div>

      <div class="header-actions" role="toolbar" aria-label="Actions">
        <button id="btn-download" class="btn" title="ÎåÄÌôî Îã§Ïö¥Î°úÎìú (JSON)"><span class="icon">‚¨áÔ∏è</span>ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
        <button id="btn-clear" class="btn" title="ÎåÄÌôî Ï¥àÍ∏∞Ìôî"><span class="icon">üßπ</span>Ï¥àÍ∏∞Ìôî</button>
        <button id="btn-theme" class="btn" title="ÌÖåÎßà Ï†ÑÌôò"><span class="icon">üéõÔ∏è</span>ÌÖåÎßà</button>
        <button id="btn-settings" class="btn" title="ÏÑ§Ï†ï"><span class="icon">‚öôÔ∏è</span>ÏÑ§Ï†ï</button>
      </div>
    </header>

    <main class="chat-wrap" id="chat" aria-live="polite"></main>

    <div class="composer" role="region" aria-label="Î©îÏãúÏßÄ ÏûÖÎ†•">
      <textarea id="input" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî ‚Äî Enter: Ï†ÑÏÜ°, Shift+Enter: Ï§ÑÎ∞îÍøà" aria-label="Î©îÏãúÏßÄ ÏûÖÎ†•"></textarea>
      <button id="btn-send" class="btn primary" title="Ï†ÑÏÜ° (Enter)"><span class="icon">‚û°Ô∏è</span>Ï†ÑÏÜ°</button>
    </div>
  </div>

  <!-- ÎùºÏù¥Î∏åÎü¨Î¶¨: marked + highlight.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/highlight.min.js"></script>

  <script>
    /* =======================
       ÏÑ§Ï†ï (Ïó¨Í∏∞Îßå Î∞îÍæ∏Î©¥ Îê®)
       ======================= */
    const API_URL_DEFAULT = 'https://yuchan5386-vechat.hf.space/api/chat'; // GET ?message=
    const STORAGE_KEY = 'vechat_v2_messages';
    const STORAGE_API_KEY = 'vechat_api_url';

    /* =======================
       Ï¥àÍ∏∞Ìôî
       ======================= */
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('btn-send');
    const btnClear = document.getElementById('btn-clear');
    const btnDownload = document.getElementById('btn-download');
    const btnTheme = document.getElementById('btn-theme');
    const btnSettings = document.getElementById('btn-settings');

    let messages = loadMessages();

    marked.setOptions({ gfm: true, breaks: true });

    (function initTheme(){
      const saved = localStorage.getItem('vechat_theme');
      if (saved === 'light') document.body.classList.add('light');
    })();

    function renderAll() {
      chatEl.innerHTML = '';
      for (const m of messages) renderMessage(m, false);
      scrollToBottom();
    }

    function renderMessage(msg, animate = true) {
      const wrapper = document.createElement('div');
      wrapper.className = 'msg ' + (msg.role === 'user' ? 'user' : 'bot');

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<span class="who">${msg.role === 'user' ? 'ÎÇò' : 'Î¥á'}</span>
                        <span class="muted">${new Date(msg.ts).toLocaleString()}</span>`;
      wrapper.appendChild(meta);

      const contentHtml = marked.parse(msg.text || '');
      const content = document.createElement('div');
      content.className = 'content';
      content.innerHTML = contentHtml;

      content.querySelectorAll('pre > code').forEach(code => {
        try { hljs.highlightElement(code); } catch(e){ }
        const pre = code.parentElement;
        const wrap = document.createElement('div');
        wrap.className = 'pre-wrap';
        wrap.style.position = 'relative';
        pre.parentNode.replaceChild(wrap, pre);
        wrap.appendChild(pre);
        if (!wrap.querySelector('.copy-btn')) {
          const cb = document.createElement('button');
          cb.className = 'copy-btn small';
          cb.textContent = 'Î≥µÏÇ¨';
          cb.title = 'ÏΩîÎìú Î≥µÏÇ¨';
          cb.onclick = async () => {
            try {
              await navigator.clipboard.writeText(code.innerText);
              cb.textContent = 'Î≥µÏÇ¨Îê®!';
              setTimeout(()=> cb.textContent = 'Î≥µÏÇ¨', 1400);
            } catch {
              cb.textContent = 'Ïã§Ìå®';
              setTimeout(()=> cb.textContent = 'Î≥µÏÇ¨', 1400);
            }
          };
          wrap.appendChild(cb);
        }
      });

      wrapper.appendChild(content);
      chatEl.appendChild(wrapper);
      if (animate) scrollToBottom();
    }

    function scrollToBottom() {
      requestAnimationFrame(()=> chatEl.scrollTop = chatEl.scrollHeight + 200);
    }

    function saveMessages() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(messages)); } catch(e){ console.warn('save failed', e); }
    }
    function loadMessages() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          const sample = [
            { role:'bot', text:'ÏïàÎÖï! ÏÉà ÎØ∏ÎãàÎ©Ä VeChatÏóê Ïò§Ïã† Í±∏ ÌôòÏòÅÌï©ÎãàÎã§. ÌÖåÏä§Ìä∏Î°ú Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥Î≥¥ÏÑ∏Ïöî.', ts: Date.now() - 60000 }
          ];
          localStorage.setItem(STORAGE_KEY, JSON.stringify(sample));
          return sample;
        }
        return JSON.parse(raw);
      } catch(e){ console.warn('load failed', e); return []; }
    }

    /* =======================
       SSE Í∏∞Î∞ò Ï†ÑÏÜ°/ÏàòÏã†
       ======================= */
    let isSending = false;
    function getApiUrlFallback(){
      return localStorage.getItem(STORAGE_API_KEY) || API_URL_DEFAULT;
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text || isSending) return;
      isSending = true;
      sendBtn.disabled = true;

      // Ïú†Ï†Ä Î©îÏãúÏßÄ Ï∂îÍ∞Ä
      const userMsg = { role:'user', text, ts: Date.now() };
      messages.push(userMsg);
      saveMessages();
      renderMessage(userMsg);
      inputEl.value = '';
      inputEl.focus();

      // Î¥á ÏûêÎ¶¨ Ï∂îÍ∞Ä (placeholder)
      const botMsg = { role:'bot', text:'', ts: Date.now() + 1 };
      messages.push(botMsg);
      saveMessages();
      renderMessage(botMsg);
      let botDom = Array.from(chatEl.querySelectorAll('.msg.bot')).pop();
      const contentNode = botDom.querySelector('.content');

      // EventSource Ïó∞Í≤∞
      const encoded = encodeURIComponent(text);
      const url = `${getApiUrlFallback()}?message=${encoded}`;

      let full = '';
      let es;
      try {
        es = new EventSource(url);
      } catch (err) {
        botMsg.text = `‚ö†Ô∏è EventSource Ïó∞Í≤∞ Ïã§Ìå®: ${err.message}`;
        saveMessages();
        contentNode.innerHTML = marked.parse(botMsg.text);
        isSending = false;
        sendBtn.disabled = false;
        return;
      }

      // onmessage: ÏÑúÎ≤ÑÍ∞Ä Î≥¥ÎÇ∏ Í∞Å data ÎùºÏù∏ Ï≤òÎ¶¨
      es.onmessage = (ev) => {
        // ev.data Îäî Î≥¥ÌÜµ JSON Î¨∏ÏûêÏó¥: {"char":"Í∞ê","done":...}
        try {
          const data = JSON.parse(ev.data);
          if (data.char !== undefined) {
            full += data.char;
            botMsg.text = full;
            saveMessages();
            // ÏïàÏ†ÑÌïòÍ≤å ÎßàÌÅ¨Îã§Ïö¥ Î≥ÄÌôò
            try {
              contentNode.innerHTML = marked.parse(full);
              contentNode.querySelectorAll('pre > code').forEach(c=> { try{ hljs.highlightElement(c); }catch{} });
            } catch(e) {
              contentNode.textContent = full;
            }
            scrollToBottom();
          } else if (data.done) {
            es.close();
            isSending = false;
            sendBtn.disabled = false;
            // ÏµúÏ¢Ö Ï†ÄÏû•ÏùÄ Ïù¥ÎØ∏ set
          } else if (data.error) {
            es.close();
            botMsg.text = `‚ö†Ô∏è ${data.error}`;
            saveMessages();
            try { contentNode.innerHTML = marked.parse(botMsg.text); } catch { contentNode.textContent = botMsg.text; }
            isSending = false;
            sendBtn.disabled = false;
          } else {
            // Í∏∞ÌÉÄ ÌïÑÎìú Ï≤òÎ¶¨(ÏûàÎã§Î©¥)
          }
        } catch (e) {
          // ÎßåÏïΩ ev.data Í∞Ä JSON ÏïÑÎãàÎ©¥ Í∑∏ÎÉ• ÌÖçÏä§Ìä∏Î°ú append
          full += ev.data;
          botMsg.text = full;
          saveMessages();
          try {
            contentNode.innerHTML = marked.parse(full);
            contentNode.querySelectorAll('pre > code').forEach(c=> { try{ hljs.highlightElement(c); }catch{} });
          } catch {
            contentNode.textContent = full;
          }
          scrollToBottom();
        }
      };

      es.onerror = (err) => {
        // Î∏åÎùºÏö∞Ï†Ä Ïù¥Î≤§Ìä∏ ÏóêÎü¨ (ÎÑ§Ìä∏ÏõåÌÅ¨/ÏÑúÎ≤Ñ Ï∞®Îã® Îì±)
        console.warn('SSE error', err);
        // Îã´Í≥† ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
        try { es.close(); } catch(e){}
        if (!full) {
          botMsg.text = '‚ö†Ô∏è Ïä§Ìä∏Î¶¨Î∞ç Ïó∞Í≤∞ Ïò§Î•ò ÎòêÎäî ÏÑúÎ≤ÑÍ∞Ä ÏùëÎãµÏùÑ Ï§ëÎã®ÌñàÏäµÎãàÎã§.';
          saveMessages();
          try { contentNode.innerHTML = marked.parse(botMsg.text); } catch { contentNode.textContent = botMsg.text; }
        } else {
          // partial content already present; leave it
        }
        isSending = false;
        sendBtn.disabled = false;
      };
    }

    /* =======================
       Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
       ======================= */
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    sendBtn.addEventListener('click', sendMessage);

    btnTheme.addEventListener('click', () => {
      document.body.classList.toggle('light');
      localStorage.setItem('vechat_theme', document.body.classList.contains('light') ? 'light' : 'dark');
    });

    btnClear.addEventListener('click', () => {
      if (!confirm('ÎåÄÌôîÎ•º Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî? (Î°úÏª¨Ïóê Ï†ÄÏû•Îêú Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§)')) return;
      messages = [];
      saveMessages();
      chatEl.innerHTML = '';
    });

    btnDownload.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(messages, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `vechat_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    btnSettings.addEventListener('click', () => {
      const cur = localStorage.getItem(STORAGE_API_KEY) || API_URL_DEFAULT;
      const newUrl = prompt('ÏÑúÎ≤Ñ ÏóîÎìúÌè¨Ïù∏Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (GET Î∞©Ïãù, ?message=... ÏòàÏãú):', cur);
      if (newUrl) {
        localStorage.setItem(STORAGE_API_KEY, newUrl);
        alert('ÏóîÎìúÌè¨Ïù∏Ìä∏ Ï†ÄÏû•Îê® ‚Äî Îã§Ïùå Ï†ÑÏÜ°Î∂ÄÌÑ∞ Ï†ÅÏö©Îê©ÎãàÎã§.');
      }
    });

    /* =======================
       ÏãúÏûë Î†åÎçî
       ======================= */
    renderAll();

    // ÏûÖÎ†•Ï∞Ω ÏûêÎèô ÌôïÏû•
    function autoResizeTextarea(el) {
      el.style.height = 'auto';
      const h = Math.min(el.scrollHeight, 160);
      el.style.height = h + 'px';
    }
    inputEl.addEventListener('input', ()=> autoResizeTextarea(inputEl));
    autoResizeTextarea(inputEl);

    (function showWelcomeToast(){
      setTimeout(()=> {
        const m = document.createElement('div');
        m.className = 'muted center';
        m.style.fontSize='13px';
        m.style.marginTop='6px';
        m.textContent = 'ÏóîÎìúÌè¨Ïù∏Ìä∏Îäî ÏÉÅÎã® ÏÑ§Ï†ïÏóêÏÑú Î∞îÍøÄ Ïàò ÏûàÏñ¥Ïöî. ÏÑúÎ≤ÑÍ∞Ä SSE/Ïä§Ìä∏Î¶¨Î∞çÏùÑ ÏßÄÏõêÌïòÎ©¥ Îçî Îß§ÎÅÑÎüΩÏäµÎãàÎã§.';
        document.querySelector('.app').insertBefore(m, document.querySelector('.app').children[1]);
        setTimeout(()=> m.remove(), 8000);
      }, 800);
    })();
  </script>
</body>
</html>
